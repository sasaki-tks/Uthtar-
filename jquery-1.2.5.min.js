  var keyid=null,partner,conn,call,msg,player,db1result,db3result,loginstatus1,loginstatus2;
  var db1data,scw,scmode=0;
  var loginid=null,myname,partnername;
  var peer = new Peer({key: '74970ce2-60ab-4978-9262-138aa51d8aa6', debug: true}); //generate peer
  var callstatus,camstatus=0,searchstatus=3,ytstatus = 0;
  var ytvideoid;
  var ytstand = 0;
  var volumedisp = 0,volumeini=0;
  var videotime,videosize,videosize2;
  var seektimer;
  var searchcnt=1;

 navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
 peer.on('open', function(id){

 keyid = id;


 }); 

function GetCookie( name )
{
    var result = null;

    var cookieName = name + '=';
    var allcookies = document.cookie;

    var position = allcookies.indexOf( cookieName );
    if( position != -1 )
    {
        var startIndex = position + cookieName.length;

        var endIndex = allcookies.indexOf( ';', startIndex );
        if( endIndex == -1 )
        {
            endIndex = allcookies.length;
        }

        result = decodeURIComponent(
            allcookies.substring( startIndex, endIndex ) );
    }

    return result;
}

function lifecheck(partnerid){
  $.ajax({
        type: 'POST',
        url: 'http://www.uthtar.com/db3.php',
        async: false,
        data: {
        'id' : partnerid
        },
        dataType: 'text'
        }) //ajax end
        .done(function(check){
          db3result = Number(check);
          if(db3result==0){
            partner = "cancel";
          }
         
        })
        .fail(function(){alert("ajax error 58");});
      
 return db3result;
}

function renewconnect(){
         // alert("reconnect");
            peer = new Peer({id:keyid,key: '74970ce2-60ab-4978-9262-138aa51d8aa6', debug: true}); 
          var c = peer.connect(partner);
             c.on('open', function(){
             connect(c);
            });

            }

 peer.on('connection', connect);

function partnersearch(){
  $.ajax({
        type: 'POST',
        url: 'http://www.uthtar.com/db1.php',
        data: {
        'id' : keyid,
        'loginid':loginid
        },
        dataType: 'text'
        }) //ajax end
        .done(function(db1result){
          db1data = db1result.split(",");
          partner = db1data[0];
          myname = db1data[4];   
         // alert("222");
        if(partner=="cancel"){
          //alert("再度接続しなおしてください。");
        //  alert(partner);
        }
        else{

       
          var c = peer.connect(partner);
             c.on('open', function(){
             connect(c);
            

            $.ajax({
        type: 'POST',
        url: 'http://www.uthtar.com/db2.php',
        data: {
        'id' : keyid,
        'partner':conn.peer,
        'loginid':loginid
        },
        dataType: 'text'
        }) //ajax end
        .done(function(db1result){
          db1data = db1result.split(",");
          partner = db1data[0];
          partnername = db1data[1];
          myname = db1data[4]; 
        })
        .fail(function(){alert("ajax error 123");});
        

            }); //229
            c.on('error', function(err){ alert(err) });

            } //226

        })
        .fail(function( jqXHR, textStatus, errorThrown){alert("ajax error 132"); console.log(jqXHR);console.log(textStatus);console.log(errorThrown);$.ajax(this);});
        
        
    $('#partnerthum').show();
      $('#their-video').hide();
      $('#mythum').show();
      $('#my-video').hide();
      $('#mute').hide();
      $('#soundon').hide();
      $('#fullscreen').hide();
      $('#mythum').show();
        $('#my-video').hide();
}
  function connect(c) {
    conn = c;


      if(partner=="cancel"){

        $.ajax({
        type: 'POST',
        url: 'http://www.uthtar.com/db2.php',
        data: {
        'id' : keyid,
        'partner':conn.peer,
        'loginid':loginid
        },
        dataType: 'text'
        }) //ajax end
        .done(function(db1result){
          db1data = db1result.split(",");
          partner = db1data[0];
          partnername = db1data[1];
          myname = db1data[4];   
          $('#partnername').text(db1data[1]);
          $('#partnerthum').prop('src', db1data[2]);
          $('#mythum').prop('src', db1data[3]);  

        })
        .fail(function(){alert("ajax error 99");});
        
        } //78 if(partner=="cancel"){

        if(loginid!=null){
        $('#mythum').prop('src', db1data[3]);  
        } 
        $('#partnername').text(db1data[1]);
        $('#partnerthum').prop('src', db1data[2]);
        $('#loading').hide();
        $('#chat_area').show();
        $('#text').show();


        $('#maincontents').css('height','90%');
    conn.on('data', function(data){
    if(data=="exitcall"){
      var theirvideo = document.getElementById("their-video");
        theirvideo.muted=true;
      
      $('#end-call').hide();
      $('#make-call').show();
      $('#partnerthum').show();
      $('#their-video').hide();
      $('#mute').hide();
      $('#soundon').hide();
      $('#fullscreen').hide();
      
      window.existingCall.close();

    }

    else if(data.indexOf("http://")!=-1 || data.indexOf("https://")!=-1 ){

      if(data.indexOf("message3")!=-1){
        var msound = document.getElementById("msound");
      msound.play();
      $('#messages').append(data);

      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
      return;
      }
      var msound = document.getElementById("msound");
      msound.play();

      $('#messages').append('<div id="messageline"><div id="message1"  class="left_balloon"><a target="_blank" href="' + data + '">' + data + '</a></div></div>');

      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
    }

    else if(data=="camtrue" && callstatus==1){
      $('#partnerthum').hide();
      $('#their-video').show();

    }
    else if(data=="camfalse" && callstatus==1){

      $('#partnerthum').show();
      $('#their-video').hide();

    }
    else if(data=="requestcallstatus"){
       if(camstatus==1){conn.send("camtrue");}
      else if(camstatus==0){conn.send("camfalse");}
    
    }
    else if(data.indexOf("<script>")!=-1){
      return;
    }
    else if(data.indexOf("ytvideoid:")!=-1){
      
      ytvideoid = data.substr(10);
      
      startplayer(ytvideoid);
      searchstatus=0;
      return;
    }
    else if(data.indexOf("ytvideoid2:")!=-1){
      return;
    }
    else if(data.indexOf("ytcontrol:")!=-1){
      return;
    }
    else if(data.indexOf("ytcontrolseek:")!=-1){
      return;
    }
    else{
        if(scmode == 1){
      $('#scmodemessage').empty();
      $('#scmodemessage').append(partnername +'> '+ data);
      $('#scmodemessage').css('display','block');
      clearTimeout(messageclear); 
      setTimeout(messageclear,3000);
    }
      var msound = document.getElementById("msound");
      msound.play();

      $('#messages').append('<div id="messageline"><div id="message1"  class="left_balloon">' + data + '</div></div>');

      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});

    }
    function messageclear(){
        $('#scmodemessage').empty();
        $('#scmodemessage').css('display','none');
      }
    });
    conn.on('close', function(err){ 

      if(db1data[2]!="http://uthtar.com/assets/images/whouser.png"){
        loginstatus2=1;
      }else{loginstatus2=0;}

    $.ajax({
    type: 'POST',
    url: 'http://www.uthtar.com/exit.php',
    data: {
    'keyid' : conn.peer,
    'loginstatus':loginstatus2
    },
    dataType: 'text'
    });

    if(loginid!=null){loginstatus1=1;}else{loginstatus1=0;}
      $.ajax({
    type: 'POST',
    url: 'http://www.uthtar.com/exit.php',
    data: {
    'keyid' : keyid,
    'loginstatus':loginstatus1
    },
    dataType: 'text'
    });
      peer.disconnect();
      alert('パートナーはチャットを終了しました。') 
      location.href = "http://www.uthtar.com/";
    });
  }

    
  


  $(document).ready(function() {
    
    $('#partnerinfo')

    .mouseover(function(e) {
      $('#controlbar').css('display','block');
    })

    .mouseout(function(e) {
      if(scw<=1500 && scmode==1){
      $('#controlbar').css('display','none');
    }
    });

    $('#myinfo')

    .mouseover(function(e) {
      $('#controlbar2').css('display','block');
    })

    .mouseout(function(e) {
      if(scw<=1500 && scmode==1){
      $('#controlbar2').css('display','none');
    }
    });

    $('#youtube')

    .mouseover(function(e) {
      if(scmode==1){
      $('#functionbar').css('display','inline-block');
      $('#functionbar').css('visibility','');
    }
      $("#functionbar").hover(
  function () {
    if(scmode==1){
      $('#functionbar').css('display','inline-block');
      $('#functionbar').css('visibility','');
    }
  
  },
  function () {
    if(scmode==1){
      $('#functionbar').css('visibility','hidden');
    }
  
  }
  );
    });

    $('#youtube')
    .mouseout(function(e) {

      if(scmode==1){
      $('#functionbar').css('visibility','hidden');
    }

  
    });

  // Conect to a peer
     $('#connect').click(function() {
      if(location.href == "http://www.uthtar.com/mypage/"){
        loginid = GetCookie("loginid");
        //alert(loginid);
      }

  scw = $(window).width();
      $('#sbutton').hide();
      $('#loading').show();

      partnersearch();
      step1();

      });

    peer.on('close', function(err){ 
    step2();
    });

  // Receiving a call
    peer.on('call', function(call){
      // Answer the call automatically (instead of prompting user) for demo purposes
    if(!window.localStream){
          navigator.getUserMedia({audio: true}, function(stream){
        // Set your video displays
        $('#my-video').prop('src', URL.createObjectURL(stream));
        window.localStream = stream;
       call.answer(window.localStream);

      step3(call);
                
      }, function(){ });
      }

    call.answer(window.localStream);
      step3(call);  
    conn.send("requestcallstatus");

    });

    peer.on('error', function(err){
      alert(err.message);
      // Return to step 2 if error occurs
      step2();
    });

    // Click handlers setup
    $(function(){
      $('#make-call').click(function(){
        // Initiate a call!     
        if(!window.localStream){
          navigator.getUserMedia({audio: true}, function(stream){
        // Set your video displays
        $('#my-video').prop('src', URL.createObjectURL(stream));
        window.localStream = stream;
        call = peer.call(conn.peer, window.localStream);
      
        step3(call);
                
      }, function(){ alert("Error:Couldn't get usermedia");});
        }else{

        }
        call = peer.call(conn.peer, window.localStream);
      
        step3(call);
        

        var theirvideo = document.getElementById("their-video");
        theirvideo.muted=false;
        $('#setting').css('display','none');
      });

      $('#end-call').click(function(){


        var theirvideo = document.getElementById("their-video");
        theirvideo.muted=true;
        
        conn.send("exitcall");
        step2();
        window.existingCall.close();
        $('#setting').css('display','block');
      });


      $('#mute').click(function(){
        var theirvideo = document.getElementById("their-video");
        theirvideo.muted=true;
        $('#mute').hide();
        $('#soundon').show();
      });

      $('#soundon').click(function(){
        var theirvideo = document.getElementById("their-video");
        theirvideo.muted=false;
        $('#mute').show();
        $('#soundon').hide();
      });

      $('#fullscreen').click(function(){
        
        var target = document.getElementById("their-video");


  if (target.webkitRequestFullscreen) {
    target.webkitRequestFullscreen(); //Chrome15+, Safari5.1+, Opera15+
  } else if (target.mozRequestFullScreen) {
    target.mozRequestFullScreen(); //FF10+
  } else if (target.msRequestFullscreen) {
    target.msRequestFullscreen(); //IE11+
  } else if (target.requestFullscreen) {
    target.requestFullscreen(); // HTML5 Fullscreen API仕様
  } else {
    alert('ご利用のブラウザはフルスクリーン操作に対応していません');
    return;
  }

      });


      $('#cam').click(function(){

        function getmedia(){
        navigator.getUserMedia({video: true}, function(stream){
        // Set your video displays
        $('#my-video').prop('src', URL.createObjectURL(stream));
        window.localStream = stream;
        }, function(){ alert("Error:Couldn't get usermedia");});
        }
        function camshow(){
        $('#mythum').hide();
        $('#my-video').show();
        $('#cam').hide();
        $('#camfalse').show();
        camstatus=1;
        if(callstatus==1){
        conn.send("camtrue");
        }
        }
        $.when(getmedia()).done(camshow());
        var camvideo = window.localStream.getVideoTracks()[0];
        camvideo.enabled = true;
      });


      $('#camfalse').click(function(){
        
        $('#mythum').show();
        $('#my-video').hide();
        $('#camfalse').hide();
        $('#cam').show();
       var camvideo = window.localStream.getVideoTracks()[0];
       camvideo.enabled = false;
        camstatus=0;
        if(callstatus==1){
        conn.send("camfalse");

      }
        
      });
      $('#setting').click(function(){

      navigator.getUserMedia({audio: true,video:true}, function(stream){
        // Set your video displays
        $('#my-video').prop('src', URL.createObjectURL(stream));
        window.localStream = stream;
                
      }, function(){ alert("Error:Couldn't get usermedia");return;});

      
      });

      $('#screenchange').click(function(){
        if(scmode==0){
        if(ytstand==0){return;}
        if(scw > 1500){
     // $('#myinfo').after($('#youtube'));
      $('#myinfo').css('float','left');
      $('#myinfo').css('width','250px');
      $('#myinfo').css('margin-top','60px');
      $('#frame1').css('width','200px');
      $('#frame1').css('height','200px');
      $('#frame1').css('margin','10% 25px');
      $('#frame2').css('width','200px');
      $('#frame2').css('height','200px');
      $('#frame2').css('margin','10% 25px');
      $('#partnerinfo').css('float','none');
      $('#partnerinfo').css('width','250px');
      $('#youtube').css('margin-top','10px');
      $('#youtube').css('width','84%');
      $('#youtube').css('height','800px');
      $('#youtube').css('margin-right','20px');
      $('#youtube').css('margin-left','20px');
      $('#youtube').css('margin-bottom','10px');
      $('#youtube').css('top','-405px');
      $('#youtube').css('float','right');
      $('#message_area').css('display','none');
      $('#functionbar').css('display','none');
      $('#functionbar').css('position','relative');
      $('#functionbar').css('top','-460px');
      $('#functionbar').css('left','275px');
      $('#functionbar').css('width','84%');
      $('#functionbar').css('background-color','rgba(255,255,255,0.03)');
      $('#videoseek').css('width','80%');
      $('#messagebox').css('top','-470px');
      $('#messagebox').css('left','100px');
      $('#messagebox').css('position','relative');
      $('#text').prop('rows','1');
      $('#maincontents').css('width','1900px');
      $('#ytbtnoff').css('display','none');
      }
      else if(scw <= 1500){
      //$('#myinfo').after($('#youtube'));
      $('#myinfo').css('float','left');   
      $('#myinfo').css('margin-top','20px');
      $('#partnerinfo').css('float','none');
      $('#partnerinfo').css('height','300px');
      $('#myinfo').css('height','300px');
      $('#youtube').css('width','79%');
      $('#youtube').css('height','590px');
      $('#youtube').css('margin-right','20px');
      $('#youtube').css('margin-left','20px');
      $('#youtube').css('top','-300px');
      $('#youtube').css('float','right');
      $('#message_area').css('display','none');
      $('#functionbar').css('display','inline-block');
      $('#functionbar').css('position','relative');
      $('#functionbar').css('top','-345px');
      $('#functionbar').css('left','280px');
      $('#functionbar').css('width','78%');
      $('#functionbar').css('background-color','rgba(255,255,255,0.03)');
      $('#videoseek').css('width','73%');
      $('#messagebox').css('top','670px');
      $('#messagebox').css('left','-220px');
      $('#messagebox').css('margin-left','50%');
      $('#messagebox').css('position','absolute');
      $('#text').prop('rows','1');
      $('#maincontents').css('width','1400px');
      $('#maincontents').css('padding','0');
      $('#controlbar').css('display','none');
      $('#controlbar').css('position','relative');
      $('#controlbar').css('top','-80px');
      $('#controlbar').css('left','0px');
      $('#controlbar').css('width','250px');
      $('#controlbar2').css('display','none');
      $('#controlbar2').css('position','relative');
      $('#controlbar2').css('top','-80px');
      $('#controlbar2').css('left','0px');
      $('#controlbar2').css('width','250px');
      $('#ytbtnoff').css('display','none');
      }
    //  player.setSize("100%","100%");
      scmode = 1;
      }else if (scmode==1){
        if(scw > 1500){
     // $('#myinfo').after($('#youtube'));
      $('#myinfo').css('float','right');
      $('#myinfo').css('width','300px');
      $('#myinfo').css('margin-top','');
      $('#frame1').css('width','250px');
      $('#frame1').css('height','250px');
      $('#frame2').css('width','250px');
      $('#frame2').css('height','250px');
      $('#partnerinfo').css('float','left');
      $('#partnerinfo').css('width','300px');
      $('#youtube').css('margin','5px 22px');
      $('#youtube').css('width','695px');
      $('#youtube').css('height','340px');
      $('#youtube').css('top','');
      $('#youtube').css('float','');
      $('#message_area').css('display','');
      $('#functionbar').css('display','');
      $('#functionbar').css('position','');
      $('#functionbar').css('top','');
      $('#functionbar').css('left','');
      $('#functionbar').css('width','540px');
      $('#functionbar').css('visibility','');
      $('#functionbar').css('background-color','rgba(255,255,255,0.3)');
      $('#videoseek').css('width','250px');
      $('#messagebox').css('top','');
      $('#messagebox').css('left','');
      $('#messagebox').css('position','');
      $('#text').prop('rows','2');
      $('#maincontents').css('width','1400px');
      $('#ytbtnoff').css('display','inline');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:1});


      }
      else if(scw <= 1500){
      //$('#myinfo').after($('#youtube'));
      $('#myinfo').css('float','right');   
      $('#myinfo').css('margin-top','');
      $('#partnerinfo').css('float','left');
      $('#partnerinfo').css('height','');
      $('#myinfo').css('height',''); 
      $('#youtube').css('width','600px');
      $('#youtube').css('height','330px');
      $('#youtube').css('margin','5px 20px');
      $('#youtube').css('top','');
      $('#youtube').css('float','left');
      $('#message_area').css('display','');
      $('#functionbar').css('display','');
      $('#functionbar').css('visibility','');
      $('#functionbar').css('position','');
      $('#functionbar').css('top','');
      $('#functionbar').css('left','');
      $('#functionbar').css('width','540px');
      $('#functionbar').css('background-color','rgba(255,255,255,0.3)');
      $('#videoseek').css('width','250px');
      $('#messagebox').css('top','');
      $('#messagebox').css('left','');
      $('#messagebox').css('margin-left','');
      $('#messagebox').css('position','');
      $('#text').prop('rows','2');
      $('#maincontents').css('width','1200px');
      $('#maincontents').css('padding','0 30px');
      $('#controlbar').css('display','block');
      $('#controlbar').css('position','');
      $('#controlbar').css('top','');
      $('#controlbar').css('left','');
      $('#controlbar').css('width','100%');
      $('#controlbar2').css('display','block');
      $('#controlbar2').css('position','');
      $('#controlbar2').css('top','');
      $('#controlbar2').css('left','');
      $('#controlbar2').css('width','100%');
      $('#ytbtnoff').css('display','inline');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:1});
      }
      scmode=0;
      }
      });

document.getElementById("search").innerHTML = "メッセージボックスにキーワードを入力して動画を検索してください";
       $('#ytbtn').click(function(){
         
         if(searchstatus==1 || searchstatus==3){
          $('#search').show();
          $('#player').hide();
          $('#ytsearch').hide();
          $('#ytsearchoff').show();
         }else{
        $('#search').hide();
        $('#player').show();
        $('#ytsearch').show();
        $('#ytsearchoff').hide();
         }
        $('#youtube').show();
        $('#youtube').show();
        if(scw>1500){
          $('#message_area').css('height','340px');

        }
        else if(scw<=1500){
         $('#message_area').css('height','170px'); 
        }
        
        $('#ytbtnoff').show();
        $('#ytbtn').hide();
                
        if(ytstatus != 0){
          $('.ytcontrol').show();
          $('#ytplay').hide();
          $('#videoseek').css('display','block');
          $('.ranger').css('display','inline-block');
        $('#seekslider').css('display','inline');
        }
        else{
          $('.ytcontrol').hide();
        }
        $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});

      });

       $('#ytbtnoff').click(function(){
        $('#youtube').hide();
        if(scw>1500){
          $('#message_area').css('height','690px');
        }
        else if(scw<=1500){
         $('#message_area').css('height','510px'); 
        }
        $('#ytbtnoff').hide();
        $('#ytbtn').show();
        $('#ytsearch').hide();
        $('#ytsearchoff').hide();
        $('.ytcontrol').hide();
        $('#volslider').css('display','none');
        $('#videoseek').css('display','none');
        $('.ranger').css('display','none');
        $('#seekslider').css('display','none');
          volumedisp = 0;
          console.log(searchstatus);
          if(searchstatus==3){}else{searchstatus = 0;}
        
      });

       $('#ytsearch').click(function(){
        $('#ytsearch').hide();
        $('#ytsearchoff').show();
        $('#search').show();
        $('#player').hide();
        searchstatus = 1;
       
        
        
      });
       $('#ytsearchoff').click(function(){
        if(ytstatus == 0){
          return;
        }
        $('#ytsearch').show();
        $('#ytsearchoff').hide();
        $('#search').hide();
        $('#player').show();
        searchstatus = 0;
        
      });

       $('#ytvolume').click(function(){
        if(volumedisp==1){
          $('#volslider').css('display','none');
          volumedisp = 0;
          $('#videoseek').css('display','block');
          $('.ranger').css('display','inline-block');
        $('#seekslider').css('display','inline');
        }
        else{
          
          $('#volslider').css('display','inline-block');
          volumedisp = 1;
          $('#videoseek').css('display','none');
        $('#seekslider').css('display','none');
        $('.ranger').css('display','none');
        if(volumeini==0){$('#volume').val(50).change();volumeini=1;}
        }
        
        
      });



       $(document).on('click', '.rbox', function(){
        $('textarea').val("");
        var id = $(this).attr("id");
        var videotitle = $(this).attr("name");
        searchstatus=0;
        if(ytstand==0){
          console.log('first');
        conn.send('<div id="messageline2"><div id="message3" class="left_balloon2" alt="' + id + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $('#messages').append('<div id="messageline2"><div id="message4" class="right_balloon2" alt="' + id + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
        startplayer(id);
        ytvideoid = id;
        conn.send("ytvideoid:" + id);
        ytstand = 1 ;
        }else if(ytstand == 1 && searchcnt ==1){
         conn.send('<div id="messageline2"><div id="message3" class="left_balloon2" alt="' + id + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $('#messages').append('<div id="messageline2"><div id="message4" class="right_balloon2" alt="' + id + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50}); 
        }
        $('#ytsearch').show();
        $('#ytsearchoff').hide();
        $('#search').hide();
        $('#player').show();
      });
       
    });

    function step1 () {
      $('#partnerthum').show();
      $('#their-video').hide();
      $('#mythum').show();
      $('#my-video').hide();
      $('#mute').hide();
      $('#soundon').hide();
      $('#fullscreen').hide();
      $('#mythum').show();
        $('#my-video').hide();
      


}

    function step2 () {
      $('#end-call').hide();
      $('#make-call').show();
      $('#partnerthum').show();
      $('#their-video').hide();
      $('#mute').hide();
      $('#soundon').hide();
      $('#fullscreen').hide();
      $('#callstatusimg').hide();
      $('#setting').css('display','block');
      callstatus = 0;
    }

    function step3 (call) {
      // Hang up on an existing call if present
      if (window.existingCall) {
        window.existingCall.close();
       
      }


      // Wait for stream on the call, then set peer video display
      call.on('stream', function(stream){
        $('#their-video').prop('src', URL.createObjectURL(stream));
        
      });

      // UI stuff
      window.existingCall = call;
      call.on('close', step2);
      step4();

    }
  function step4 () {
      $('#end-call').show();
      $('#make-call').hide();
      $('#mute').show();
      $('#fullscreen').show();
      $('#callstatusimg').show();
      $('#setting').css('display','none');
      callstatus = 1;
      conn.send("requestcallstatus");
    }
  

      
$( '#text' ).keypress( function ( e ) {
  if ( e.which == 13 ) {
     msg = $('#text').val();
    if(msg == ""){return false;}
    else if(msg.indexOf("<script>")!=-1){
      var msgbox = document.getElementById("text") ;
      msgbox.value = "" ;
      return;
    }
    else if(msg.indexOf("http://")!=-1 || msg.indexOf("https://")!=-1 ){
      conn.send(msg);

      $('#messages').append('<div id="messageline"><div id="message2"  class="right_balloon"><a target="_blank" href="' + msg + '">' + msg + '</a></div></div>');

      $('#text').val('');

      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
      return;
    }
    else if(searchstatus == 3){
      if($('#youtube').css('display')=='block'){
      ytsearch();
      var v = $('#text').val();
      $('#text').val('');  
      $('#text').focus().val(v);
      return;}else{conn.send(msg);
      $('#messages').append('<div id="messageline"><div id="message2" class="right_balloon">' + msg+'</div></div>');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
      $('#text').val('');}
    }
    else if(searchstatus == 1){
      
      ytsearch();
      var v = $('#text').val();   
      $('#text').val(''); 
      $('#text').focus().val(v);
      return;
    }
    else{
      if(scmode == 1){
      $('#scmodemessage').empty();
      $('#scmodemessage').append(myname +'> '+ msg);
      $('#scmodemessage').css('display','block');
      clearTimeout(messageclear); 
      setTimeout(messageclear,3000);
    }
      conn.send(msg);
      if(msg=="exitcall"){
        window.existingCall.close();
      $('#end-call').hide();
      $('#make-call').show();
      $('#partnerthum').show();
      $('#their-video').hide();
      $('#mute').hide();
      $('#soundon').hide();
      $('#fullscreen').hide();
      }
      $('#messages').append('<div id="messageline"><div id="message2" class="right_balloon">' + msg+'</div></div>');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
      $('#text').val('');

      }
      
    return false;
  }
} );
function messageclear(){
        $('#scmodemessage').empty();
        $('#scmodemessage').css('display','none');
      }
    // Close a connection.
    $('#exit').click(function() {
      try{
    eachActiveConnection(function(c) {
      c.close();
    });

  }catch(e){}
 peer.disconnect();
    $.ajax({
    type: 'POST',
    url: 'http://www.uthtar.com/exit.php',
    dataType: 'text',
    data: {
    'keyid' : keyid
    },
    });
    });

}); //docment ready end
  window.onunload = window.onbeforeunload = function(e) {
  if (!!peer && !peer.destroyed) {
    peer.destroy();
  }
};



function ytsearch(){
searchcnt=0;
$.ajax({
    type:"GET",
    url:'https://www.googleapis.com/youtube/v3/search?part=snippet&q=' + document.getElementById("text").value + '&key=AIzaSyA3fB3hiLft5Ru6vgVDVHNNUrKjKyztodo&maxResults=30',
    dataType: 'json'
  })

    .done(function(data) {
      $('#mCSB_1_container').empty();
      $(".scrollbar").mCustomScrollbar();
      while (searchcnt < 30){
        $('#mCSB_1_container').append('<div id="resultbox" ><img id="' + data.items[searchcnt].id.videoId + '" class="rbox" name="' + data.items[searchcnt].snippet.title +'" src="' + data.items[searchcnt].snippet.thumbnails.default.url + '"><div id="yttitle">' + data.items[searchcnt].snippet.title + '</div><div id="ytdescription">' + data.items[searchcnt].snippet.description + '</div></div>');
      searchcnt++;
      }
     
      $("#search").mCustomScrollbar("scrollTo","top",{scrollInertia:50});
    })
   
  .fail(function(xOptions, textStatus){
      alert('error：' + textStatus);
    });

}

function startplayer(searchid){
 var videoID = searchid;

$(function loadytplayer(){
        if(ytstand==1){
          player.loadVideoById(videoID);
          play(); 
        }
        else{player = null;}
        //var videoID = searchid2;
  
        function fGetScript(){
          $.ajax({
            url:"http://www.youtube.com/player_api/",
            dataType:"script"
          })
            .done(function(data){
              dbg("done");
            })
            .fail(function(xhr, status, thrown) {
              dbg(xhr);
              fGetScript();
            });

          window.onYouTubeIframeAPIReady=function() {
          dbg("onYouTubeIframeAPIReady");
          loadPlayer(videoID);
         }
        }
        fGetScript();

        $(document).ready(function() {


        $( '#volume' ).on( 'input', function () {

        
        var val = $(this).val();
        playerSetVolume(val);
        
        } );
        $( '#videoseek' ).on( 'input', function () {
         
        var val = $(this).val();
        player.seekTo(val);
        play(); 
        conn.send("ytcontrolseek:" + val);
        //document.activeElement.blur();
        
        } );

       $(document).on('click', '.rbox', function(){
      $('textarea').val("");
       var id = $(this).attr("id");
       player.loadVideoById(id);
       play();
       conn.send("ytvideoid2:" + id);
         ytvideoid = id;
         var videotitle = $(this).attr("name");
         console.log('2nd');
        conn.send('<div id="messageline2"><div id="message3" class="left_balloon2" alt="' + id + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $('#messages').append('<div id="messageline2"><div id="message4" class="right_balloon2" alt="' + id + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
       });

       $(document).on('click', '#message3', function(){
       var title = $(this).attr("alt");
       videotitle = $(this).text();
       console.log(videotitle);
       if(!title){return;}
       console.log(title);
         player.loadVideoById(title);    
       play();
       conn.send("ytvideoid2:" + title);
       ytvideoid = title;
         console.log('3rd');
        conn.send('<div id="messageline2"><div id="message3" class="left_balloon2" alt="' + ytvideoid + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $('#messages').append('<div id="messageline2"><div id="message4" class="right_balloon2" alt="' + title + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
      });

       $(document).on('click', '#message4', function(){
       var title = $(this).attr("alt");
       videotitle = $(this).text();
       console.log(videotitle);
       if(!title){return;}
       console.log(title);
         player.loadVideoById(title);    
       play();
       conn.send("ytvideoid2:" + title);
       ytvideoid = title;
         console.log('3rd');
        conn.send('<div id="messageline2"><div id="message3" class="left_balloon2" alt="' + ytvideoid + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $('#messages').append('<div id="messageline2"><div id="message4" class="right_balloon2" alt="' + title + '"><img src="http://www.uthtar.com/assets/images/yticon.png" id="yticon">' + videotitle+'</div></div>');
      $("#message_area").mCustomScrollbar("scrollTo","bottom",{scrollInertia:50});
      });



        conn.on('data', function(data){
        if(data.indexOf("ytvideoid2:")!=-1){

        var id = data.substr(11);
        ytvideoid= id;
        //alert(id);
        player.loadVideoById(id);
        return;
        }
        else if(data == "ytcontrol:play"){
          play();
        }
        else if(data == "ytcontrol:pause"){
          pause();
        }
        else if(data == "ytcontrol:stop"){
          stop();
        }
        else if(data.indexOf("ytcontrolseek:")!=-1){
        videotime = data.substr(14);
        player.seekTo(videotime);
       }
        
        

        });

        $('#ytplay').click(function(){
        play();
        conn.send("ytcontrol:play");
        
        });

        $('#ytpause').click(function(){
        pause();
        conn.send("ytcontrol:pause");
        });

        $('#ytstop').click(function(){
        stop();
        conn.send("ytcontrol:stop");
       
        });

        });

        

        function loadPlayer(videoID) {
          ytstand=1;
          dbg("loadPlayer("+videoID+")");
          if(!player){
            
            player = new YT.Player(
              'player',{
                width: '100%',
                height: '100%',  
                videoId: videoID, 
                events: { 
                  "onReady": onPlayerReady,
                  "onStateChange": onPlayerStateChange, 
                },
                playerVars: {
                  "rel":0,     
                  "showinfo":0, 
                  "controls":0   
                }
              }
            );
          }else{
            player.loadVideoById(videoID);

          }

        }
        function onPlayerReady(event){
          dbg("onPlayerReady");
          play();
        }
        function onPlayerStateChange(event) {
          dbg("PlayerState:"+event.data);
          switch(event.data){
            case YT.PlayerState.ENDED:{conn.send("ytcontrol:stop");stop();}
            case YT.PlayerState.PAUSED:conn.send("ytcontrol:pause");
            case YT.PlayerState.CUED:
              break;
            case YT.PlayerState.PLAYING:conn.send("ytcontrol:play");
            case YT.PlayerState.BUFFERING:
              break;
            default:
              break;
          }
        }
        function videoseek(){
         videotime = player.getCurrentTime();
         videosize = player.getDuration();
         $('#videoseek').val(videotime);
         $('#videoseek').prop('max',videosize);
        }
        function play(){
          //if(ytstatus==1){return;}
         // else{
        //    conn.send("ytcontrol:play");
        $('#search').hide();
        $('#player').show();
        $('#youtube').show();
        $('#ytsearch').show();
        $('#ytsearchoff').hide();
        if(scw>1500){
          $('#message_area').css('height','340px');
        }
        else if(scw<=1500){
         $('#message_area').css('height','170px'); 
        }
        $('#videoseek').css('display','block');
        $('#seekslider').css('display','inline');
        $('.ranger').css('display','inline-block');
        $('#volslider').css('display','none');
          volumedisp = 0;
          dbg("play");
          player.playVideo();
          searchstatus=0;          
          $('.ytcontrol').show();
          $('#ytplay').hide();
          if(scmode!=1){$('#ytbtnoff').show();}
          
          $('#ytbtn').hide();
          ytstatus = 1;
           clearInterval(seektimer);
           seektimer = setInterval(videoseek,100);
           //} // return else end
        }

        function pause(){
          dbg("pause");
          player.pauseVideo(); 
          $('#ytplay').show();
          $('#ytpause').hide();
          ytstatus = 2;
        }
        function stop(){
          $('#ytplay').show();
          $('#ytpause').hide();
          dbg("stop");
          player.stopVideo(); 
          player.cueVideoById(ytvideoid);
          $('#videoseek').css('display','none');
        $('#seekslider').css('display','none');
          ytstatus = 3;
          $('#videoseek').val(0);
          clearInterval(seektimer);
          return;
          
        }

        function playerSetVolume(volume) {
        if (player && volume >= 0 && volume <= 100) {
            player.setVolume(volume);
        }
    }
        
        
        function dbg(str){
          $("#debuglog").val(str+"\n"+$("#debuglog").val());
            if(window.console && window.console.log){
              console.log(str);
            }
        }
      });
}


